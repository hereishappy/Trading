<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Shift Management - Site Work</title>
    <!-- Bootstrap 5 CDN -->
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .card-group {display:flex;gap:2rem;flex-wrap:wrap;justify-content:center;margin-top:3vh;}
      .shift-card {min-width:320px;max-width:380px;margin-bottom:2rem;}
      @media (max-width: 768px) {
        .card-group {flex-direction: column;align-items: center;}
        .shift-card {max-width:95vw;}
      }
      .hide {display:none;}
      .workers-list label { margin-right:12px; min-width: 120px;}
    </style>
    <script>
      const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxBgpPyplN2hSsLP-ZPrP9scpAOXjupBuxTeXQDwOtey4Xnu0qTTPxkbeI-XjJMO848/exec";
      let appConfig = {};
      let entries = [];
      let endShiftOts = {};

      window.onload = async function() {
        try {
          const res = await fetch(`${WEB_APP_URL}?action=getAppData`);
          appConfig = await res.json();
          populateSupervisorDropdown('start-login-supervisor');
          populateSupervisorDropdown('end-login-supervisor');
          populateWorkersList();
        } catch (e) {
          alert("Error loading app config: " + e);
        }
      };

      function populateSupervisorDropdown(id) {
        const el = document.getElementById(id);
        el.innerHTML = "<option value=''>Select supervisor</option>";
        appConfig.supervisors.forEach(sv => {
          el.innerHTML += `<option value="${sv}">${sv}</option>`;
        });
      }

      function populateWorkersList() {
        const wl = document.getElementById('start-workers-list');
        if (!wl) return;
        wl.innerHTML = "";
        appConfig.workers.forEach(w => {
          wl.innerHTML += `<div class="form-check">
                <input class="form-check-input" type="checkbox" value="${w}" id="chk-${w.replace(/\s+/g,'-')}" name="workers">
                <label class="form-check-label" for="chk-${w.replace(/\s+/g,'-')}">${w}</label>
              </div>`;
        });
      }

      async function startLogin() {
        const supervisor = document.getElementById('start-login-supervisor').value;
        const passcode = document.getElementById('start-login-passcode').value;
        if (!supervisor || passcode.length !== 4) return alert('Fill all fields with valid data.');

        try {
          const res = await fetch(`${WEB_APP_URL}?action=validateSupervisorLogin&supervisor=${encodeURIComponent(supervisor)}&passcode=${encodeURIComponent(passcode)}`);
          const valid = await res.json();
          if (valid) {
            document.getElementById('start-shift-login').classList.add('hide');
            showStartShiftCard(supervisor);
          } else alert('Invalid login or passcode. Try again.');
        } catch (e) {
          alert("Login error: " + e);
        }
      }

      async function endLogin() {
        const supervisor = document.getElementById('end-login-supervisor').value;
        const passcode = document.getElementById('end-login-passcode').value;
        if (!supervisor || passcode.length !== 4) return alert('Fill all fields with valid data.');

        try {
          const res = await fetch(`${WEB_APP_URL}?action=validateSupervisorLogin&supervisor=${encodeURIComponent(supervisor)}&passcode=${encodeURIComponent(passcode)}`);
          const valid = await res.json();
          if (valid) {
            document.getElementById('end-shift-login').classList.add('hide');
            showEndShiftEntry(supervisor);
          } else alert('Invalid login or passcode. Try again.');
        } catch (e) {
          alert("Login error: " + e);
        }
      }

      function showStartShiftCard(supervisor) {
        document.getElementById('start-shift-form').classList.remove('hide');
        document.getElementById('start-supervisor-name').value = supervisor;
        document.getElementById('start-date-input').value = new Date().toISOString().slice(0,10);
        populateWorkersList();
      }

      async function submitStartShift() {
        const supervisor = document.getElementById('start-supervisor-name').value;
        const date = document.getElementById('start-date-input').value;
        const workerInputs = document.querySelectorAll('input[name="workers"]:checked');
        const selected = Array.from(workerInputs).map(input=>input.value);
        if (!supervisor || !date || selected.length<1) return alert("Select at least one worker!");

        try {
          await fetch(`${WEB_APP_URL}?action=saveStartShift`, {
            method: 'POST',
            body: JSON.stringify({date, supervisor, workers: selected}),
            headers: {'Content-Type': 'application/json'}
          });
          alert("Start shift saved successfully.");
          window.location.reload();
        } catch (e) {
          alert("Error saving shift: " + e);
        }
      }

      function showEndShiftEntry(supervisor) {
        document.getElementById('end-entry-form').classList.remove('hide');
        document.getElementById('end-supervisor-name').innerText = supervisor;
        document.getElementById('end-date-input').value = new Date().toISOString().slice(0,10);
        entries = [];
        renderEndShiftEntries();
      }

      function addEndShiftEntry() {
        const type = document.getElementById('end-type').value;
        const desc = document.getElementById('end-desc').value.trim();
        const l = Number(document.getElementById('end-length').value);
        const w = Number(document.getElementById('end-width').value);
        const h = Number(document.getElementById('end-height').value);
        const qty = Number(document.getElementById('end-qty').value);
        if (!type || !desc || l<=0 || w<=0 || h<=0 || qty<=0) return alert('All fields required, no negatives or zeros!');
        const volume = l*w*h*qty;
        entries.push({type, description: desc, length: l, width:w, height:h, quantity:qty, volume});
        renderEndShiftEntries();
        document.getElementById('end-desc').value='';
        ['end-length','end-width','end-height','end-qty'].forEach(id=>document.getElementById(id).value='');
      }

      function renderEndShiftEntries(){
        const tbl = document.getElementById('end-entries-table');
        tbl.innerHTML = '';
        if (!entries.length) return;
        tbl.innerHTML = `
          <tr><th>#</th><th>Type</th><th>Description</th><th>LxWxH</th><th>Qty</th><th>Volume</th></tr>
          ${entries.map((e,i)=>`<tr>
          <td>${i+1}</td>
          <td>${e.type}</td>
          <td>${e.description}</td>
          <td>${e.length}x${e.width}x${e.height}</td>
          <td>${e.quantity}</td>
          <td>${e.volume}</td>
          </tr>`).join('')}`;
      }

      function submitEndEntries() {
        if (!entries.length) return alert('Add at least one entry!');
        document.getElementById('end-entry-form').classList.add('hide');
        document.getElementById('end-ot-form').classList.remove('hide');
        const wl = document.getElementById('end-ot-workers');
        wl.innerHTML = '';
        appConfig.workers.forEach(w=>{
          wl.innerHTML += `<tr>
              <td>${w}</td>
              <td><input class="form-control" type="number" min="0" max="12" value="0" id="ot-${w.replace(/\s+/g,'-')}"></td>
          </tr>`;
        });
      }

      async function submitEndAndClose() {
        const supervisor = document.getElementById('end-supervisor-name').innerText;
        const date = document.getElementById('end-date-input').value;
        endShiftOts = {};
        appConfig.workers.forEach(w=>{
          const otVal = Number(document.getElementById(`ot-${w.replace(/\s+/g,'-')}`).value)||0;
          endShiftOts[w]=otVal;
        });

        try {
          await fetch(`${WEB_APP_URL}?action=saveEndShift`, {
            method: 'POST',
            body: JSON.stringify({
              date, supervisor,
              entries, overtimesObj:endShiftOts
            }),
            headers: {'Content-Type': 'application/json'}
          });
          alert("End shift saved successfully.");
          window.location.reload();
        } catch (e) {
          alert('Error: '+e.message);
        }
      }

      function logout() {window.location.reload();}
    </script>
  </head>
  <body class="bg-light">
    <!-- Body remains the same -->
  </body>
</html>
