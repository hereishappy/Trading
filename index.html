<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Attendance Report</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            padding: 30px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8fafc;
        }

        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .summary-card h3 {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .summary-card p {
            color: #6b7280;
            font-weight: 500;
        }

        .summary-card.total { border-left: 4px solid #4f46e5; }
        .summary-card.hours { border-left: 4px solid #10b981; }
        .summary-card.overtime { border-left: 4px solid #f59e0b; }

        .table-container {
            padding: 30px;
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .table th {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .table td {
            padding: 16px 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9rem;
        }

        .table tbody tr:hover {
            background: #f8fafc;
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .no-data-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .controls {
                padding: 20px;
            }

            .controls-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                justify-content: center;
            }

            .summary-cards {
                padding: 20px;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }

            .summary-card {
                padding: 20px;
            }

            .table-container {
                padding: 20px;
            }

            .table {
                font-size: 0.8rem;
            }

            .table th, .table td {
                padding: 12px 8px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 12px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Employee Attendance Report</h1>
            <p>Comprehensive attendance tracking and reporting system</p>
        </div>

        <div class="controls">
            <div class="controls-grid">
                <div class="form-group">
                    <label for="dateFrom">From Date</label>
                    <input type="date" id="dateFrom">
                </div>
                <div class="form-group">
                    <label for="dateTo">To Date</label>
                    <input type="date" id="dateTo">
                </div>
                <div class="form-group">
                    <label for="supervisorFilter">Supervisor</label>
                    <select id="supervisorFilter">
                        <option value="">All Supervisors</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="employeeFilter">Employee</label>
                    <select id="employeeFilter">
                        <option value="">All Employees</option>
                    </select>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="loadData()">
                    üîÑ Refresh Data
                </button>
                <button class="btn btn-primary" onclick="filterData()">
                    üîç Apply Filters
                </button>
                <button class="btn btn-success" onclick="downloadPDF()">
                    üìÑ Download PDF Report
                </button>
            </div>
        </div>

        <div id="loadingSection" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Loading attendance data...</p>
        </div>

        <div id="summarySection" class="summary-cards" style="display: none;">
            <div class="summary-card total">
                <h3 id="totalEmployees">0</h3>
                <p>Total Employees</p>
            </div>
            <div class="summary-card hours">
                <h3 id="totalHours">0</h3>
                <p>Total Hours</p>
            </div>
            <div class="summary-card overtime">
                <h3 id="totalOvertime">0</h3>
                <p>Overtime Hours</p>
            </div>
        </div>

        <div class="table-container">
            <div id="noDataSection" class="no-data" style="display: none;">
                <div class="no-data-icon">üìã</div>
                <h3>No Data Available</h3>
                <p>Click "Refresh Data" to load attendance records</p>
            </div>
            
            <table id="attendanceTable" class="table" style="display: none;">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Supervisor</th>
                        <th>Employee Name</th>
                        <th>Shift Hours</th>
                        <th>OT Hours</th>
                        <th>Total Hours</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let attendanceData = [];
        let filteredData = [];

        // Set default dates (last 30 days)
        function setDefaultDates() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            document.getElementById('dateTo').value = today.toISOString().split('T')[0];
            document.getElementById('dateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
        }

        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                if (values.length >= headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }
            return data;
        }

        // Load data from CSV
        async function loadData() {
            const loadingSection = document.getElementById('loadingSection');
            const summarySection = document.getElementById('summarySection');
            const noDataSection = document.getElementById('noDataSection');
            const table = document.getElementById('attendanceTable');

            loadingSection.style.display = 'block';
            summarySection.style.display = 'none';
            noDataSection.style.display = 'none';
            table.style.display = 'none';

            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRxODcmDFDJLfScffQaei0ejYlolvQKi32KiWBBAp97WO7lLuD1TZHgK-ibCMn5kmW_0CsQHZMzcrHp/pub?gid=1727336003&single=true&output=csv');
                const csvText = await response.text();
                
                attendanceData = parseCSV(csvText);
                
                if (attendanceData.length === 0) {
                    throw new Error('No data found');
                }

                // Populate filter dropdowns
                populateFilters();
                
                // Apply initial filter
                filterData();
                
            } catch (error) {
                console.error('Error loading data:', error);
                loadingSection.style.display = 'none';
                noDataSection.style.display = 'block';
                noDataSection.innerHTML = `
                    <div class="no-data-icon">‚ö†Ô∏è</div>
                    <h3>Error Loading Data</h3>
                    <p>Unable to fetch attendance data. Please check your connection and try again.</p>
                `;
            }
        }

        // Populate filter dropdowns
        function populateFilters() {
            const supervisors = [...new Set(attendanceData.map(row => row.Supervisor || row.supervisor || '').filter(s => s))];
            const employees = [...new Set(attendanceData.map(row => row['EMP NAME'] || row['Employee Name'] || row.employee || '').filter(e => e))];

            const supervisorSelect = document.getElementById('supervisorFilter');
            const employeeSelect = document.getElementById('employeeFilter');

            // Clear existing options (except "All")
            supervisorSelect.innerHTML = '<option value="">All Supervisors</option>';
            employeeSelect.innerHTML = '<option value="">All Employees</option>';

            supervisors.forEach(supervisor => {
                const option = document.createElement('option');
                option.value = supervisor;
                option.textContent = supervisor;
                supervisorSelect.appendChild(option);
            });

            employees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee;
                option.textContent = employee;
                employeeSelect.appendChild(option);
            });
        }

        // Filter data based on selected criteria
        function filterData() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const supervisorFilter = document.getElementById('supervisorFilter').value;
            const employeeFilter = document.getElementById('employeeFilter').value;

            filteredData = attendanceData.filter(row => {
                const rowDate = new Date(row.Date || row.date || '');
                const fromDate = dateFrom ? new Date(dateFrom) : null;
                const toDate = dateTo ? new Date(dateTo) : null;

                // Date filter
                if (fromDate && rowDate < fromDate) return false;
                if (toDate && rowDate > toDate) return false;

                // Supervisor filter
                if (supervisorFilter && (row.Supervisor || row.supervisor || '') !== supervisorFilter) return false;

                // Employee filter
                if (employeeFilter && (row['EMP NAME'] || row['Employee Name'] || row.employee || '') !== employeeFilter) return false;

                return true;
            });

            updateDisplay();
        }

        // Update display with filtered data
        function updateDisplay() {
            const loadingSection = document.getElementById('loadingSection');
            const summarySection = document.getElementById('summarySection');
            const noDataSection = document.getElementById('noDataSection');
            const table = document.getElementById('attendanceTable');

            loadingSection.style.display = 'none';

            if (filteredData.length === 0) {
                summarySection.style.display = 'none';
                table.style.display = 'none';
                noDataSection.style.display = 'block';
                return;
            }

            // Update summary
            updateSummary();
            summarySection.style.display = 'grid';

            // Update table
            updateTable();
            table.style.display = 'table';
            noDataSection.style.display = 'none';
        }

        // Update summary cards
        function updateSummary() {
            const uniqueEmployees = new Set(filteredData.map(row => row['EMP NAME'] || row['Employee Name'] || row.employee || '')).size;
            const totalHours = filteredData.reduce((sum, row) => {
                const shiftHours = parseFloat(row['Shift Hours'] || row['shift_hours'] || 0);
                return sum + (isNaN(shiftHours) ? 0 : shiftHours);
            }, 0);
            const totalOvertime = filteredData.reduce((sum, row) => {
                const otHours = parseFloat(row['OT HOURS'] || row['ot_hours'] || 0);
                return sum + (isNaN(otHours) ? 0 : otHours);
            }, 0);

            document.getElementById('totalEmployees').textContent = uniqueEmployees;
            document.getElementById('totalHours').textContent = totalHours.toFixed(1);
            document.getElementById('totalOvertime').textContent = totalOvertime.toFixed(1);
        }

        // Update table with data
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            filteredData.forEach(row => {
                const tr = document.createElement('tr');
                const date = row.Date || row.date || '';
                const supervisor = row.Supervisor || row.supervisor || '';
                const employee = row['EMP NAME'] || row['Employee Name'] || row.employee || '';
                const shiftHours = parseFloat(row['Shift Hours'] || row['shift_hours'] || 0);
                const otHours = parseFloat(row['OT HOURS'] || row['ot_hours'] || 0);
                const totalHours = (isNaN(shiftHours) ? 0 : shiftHours) + (isNaN(otHours) ? 0 : otHours);

                tr.innerHTML = `
                    <td>${date}</td>
                    <td>${supervisor}</td>
                    <td>${employee}</td>
                    <td>${isNaN(shiftHours) ? '0' : shiftHours.toFixed(1)}</td>
                    <td>${isNaN(otHours) ? '0' : otHours.toFixed(1)}</td>
                    <td><strong>${totalHours.toFixed(1)}</strong></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Download PDF report
        function downloadPDF() {
            if (filteredData.length === 0) {
                alert('No data to export. Please load data first.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Add title
            doc.setFontSize(20);
            doc.setTextColor(79, 70, 229);
            doc.text('Employee Attendance Report', 20, 30);

            // Add date range
            const dateFrom = document.getElementById('dateFrom').value || 'All dates';
            const dateTo = document.getElementById('dateTo').value || 'All dates';
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Report Period: ${dateFrom} to ${dateTo}`, 20, 45);

            // Add summary
            const uniqueEmployees = new Set(filteredData.map(row => row['EMP NAME'] || row['Employee Name'] || row.employee || '')).size;
            const totalHours = filteredData.reduce((sum, row) => {
                const shiftHours = parseFloat(row['Shift Hours'] || row['shift_hours'] || 0);
                return sum + (isNaN(shiftHours) ? 0 : shiftHours);
            }, 0);
            const totalOvertime = filteredData.reduce((sum, row) => {
                const otHours = parseFloat(row['OT HOURS'] || row['ot_hours'] || 0);
                return sum + (isNaN(otHours) ? 0 : otHours);
            }, 0);

            doc.text(`Total Employees: ${uniqueEmployees}`, 20, 60);
            doc.text(`Total Hours: ${totalHours.toFixed(1)}`, 20, 70);
            doc.text(`Total Overtime: ${totalOvertime.toFixed(1)}`, 20, 80);

            // Prepare table data
            const tableData = filteredData.map(row => [
                row.Date || row.date || '',
                row.Supervisor || row.supervisor || '',
                row['EMP NAME'] || row['Employee Name'] || row.employee || '',
                (parseFloat(row['Shift Hours'] || row['shift_hours'] || 0) || 0).toFixed(1),
                (parseFloat(row['OT HOURS'] || row['ot_hours'] || 0) || 0).toFixed(1),
                ((parseFloat(row['Shift Hours'] || row['shift_hours'] || 0) || 0) + (parseFloat(row['OT HOURS'] || row['ot_hours'] || 0) || 0)).toFixed(1)
            ]);

            // Add table
            doc.autoTable({
                head: [['Date', 'Supervisor', 'Employee', 'Shift Hours', 'OT Hours', 'Total Hours']],
                body: tableData,
                startY: 95,
                styles: {
                    fontSize: 8,
                    cellPadding: 3
                },
                headStyles: {
                    fillColor: [79, 70, 229],
                    textColor: 255
                },
                alternateRowStyles: {
                    fillColor: [248, 250, 252]
                }
            });

            // Save the PDF
            const today = new Date().toISOString().split('T')[0];
            doc.save(`attendance-report-${today}.pdf`);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            setDefaultDates();
            loadData();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'974be785875ba0b4',t:'MTc1NjEzMzQ1NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
