<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #555;
        }

        select, input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .employee-list {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 12px;
        }

        .employee-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .employee-item:last-child {
            border-bottom: none;
        }

        .employee-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .hidden {
            display: none;
        }

        .work-entry {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #e9ecef;
        }

        .work-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .remove-entry {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .input-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 14px;
        }

        .summary-table th,
        .summary-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .summary-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .overtime-input {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .overtime-input:last-child {
            border-bottom: none;
        }

        .overtime-input input {
            width: 80px;
            margin-left: 10px;
        }

        .back-btn {
            background: #6c757d;
            margin-bottom: 12px;
        }

        .add-entry-btn {
            background: #28a745;
            margin-bottom: 16px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading Screen -->
        <div id="loadingScreen">
            <div class="card">
                <div class="loading">Loading...</div>
            </div>
        </div>

        <!-- Main Menu -->
        <div id="mainMenu" class="hidden">
            <div class="card">
                <h2 class="card-title">Start Shift</h2>
                <button class="btn" onclick="showStartShift()">Begin Shift Login</button>
            </div>
            
            <div class="card">
                <h2 class="card-title">End Shift</h2>
                <button class="btn" onclick="showEndShift()">End Shift Login</button>
            </div>
        </div>

        <!-- Start Shift Login -->
        <div id="startShiftLogin" class="hidden">
            <div class="card">
                <h2 class="card-title">Start Shift - Login</h2>
                <form id="startLoginForm">
                    <div class="form-group">
                        <label for="startSupervisor">Supervisor</label>
                        <select id="startSupervisor" required>
                            <option value="">Select Supervisor</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="startPassword">Password</label>
                        <input type="password" id="startPassword" placeholder="4-digit passcode" maxlength="4" required>
                    </div>
                    
                    <button type="submit" class="btn">Login</button>
                    <button type="button" class="btn back-btn" onclick="showMainMenu()">Back</button>
                </form>
            </div>
        </div>

        <!-- Start Shift Employee Selection -->
        <div id="startShiftEmployees" class="hidden">
            <div class="card">
                <h2 class="card-title">Start Shift</h2>
                <div class="form-group">
                    <label>Supervisor: <span id="lockedSupervisor"></span></label>
                </div>
                
                <div class="form-group">
                    <label for="shiftDate">Date</label>
                    <input type="date" id="shiftDate" required>
                </div>
                
                <div class="form-group">
                    <label>Select Employees</label>
                    <div class="employee-list" id="employeeList">
                        <!-- Employees will be loaded here -->
                    </div>
                </div>
                
                <button class="btn" onclick="submitStartShift()">Submit & Send to WhatsApp</button>
                <button class="btn back-btn" onclick="showMainMenu()">Cancel</button>
            </div>
        </div>

        <!-- End Shift Login -->
        <div id="endShiftLogin" class="hidden">
            <div class="card">
                <h2 class="card-title">End Shift - Login</h2>
                <form id="endLoginForm">
                    <div class="form-group">
                        <label for="endSupervisor">Supervisor</label>
                        <select id="endSupervisor" required>
                            <option value="">Select Supervisor</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="endPassword">Password</label>
                        <input type="password" id="endPassword" placeholder="4-digit passcode" maxlength="4" required>
                    </div>
                    
                    <button type="submit" class="btn">Login</button>
                    <button type="button" class="btn back-btn" onclick="showMainMenu()">Back</button>
                </form>
            </div>
        </div>

        <!-- End Shift Work Details -->
        <div id="endShiftWork" class="hidden">
            <div class="card">
                <h2 class="card-title">Work Details</h2>
                <div class="form-group">
                    <label>Supervisor: <span id="endLockedSupervisor"></span></label>
                </div>
                
                <div id="workEntries">
                    <!-- Work entries will be added here -->
                </div>
                
                <button class="btn add-entry-btn" onclick="addWorkEntry()">Add Work Entry</button>
                
                <div id="workSummary" class="hidden">
                    <h3>Work Summary</h3>
                    <table class="summary-table" id="summaryTable">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Description</th>
                                <th>L×W×H</th>
                                <th>Qty</th>
                                <th>Volume</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <button class="btn" onclick="proceedToOvertime()">Continue to Overtime</button>
                <button class="btn back-btn" onclick="showMainMenu()">Cancel</button>
            </div>
        </div>

        <!-- Overtime Input -->
        <div id="overtimeInput" class="hidden">
            <div class="card">
                <h2 class="card-title">Overtime Hours</h2>
                <div class="form-group">
                    <label>Enter overtime hours for each employee:</label>
                    <div id="overtimeList">
                        <!-- Overtime inputs will be loaded here -->
                    </div>
                </div>
                
                <button class="btn" onclick="submitEndShift()">Submit & Send to WhatsApp</button>
                <button class="btn back-btn" onclick="showEndShiftWork()">Back</button>
            </div>
        </div>
    </div>

    <script>
        // API Configuration - Replace with your Google Apps Script URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwsWDawOp3uSAw0tLqf0K98unUNaV-K9WEC111WUk0MEk8lOnqxNDzQ1h62j8mgsN_hAw/exec';
        
        let supervisors = [];
        let employees = [];
        let currentSupervisor = "";
        let selectedEmployees = [];
        let workEntries = [];
        let overtimeHours = {};

        // Initialize app
        window.onload = function() {
            loadInitialData();
        };

        // API Helper function
        async function callAPI(action, data = {}) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action,
                        ...data
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success === false) {
                    throw new Error(result.message || 'API call failed');
                }
                
                return result;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        async function loadInitialData() {
            try {
                // Load supervisors and workers in parallel
                const [supervisorsData, workersData] = await Promise.all([
                    callAPI('getSupervisors'),
                    callAPI('getWorkers')
                ]);
                
                supervisors = supervisorsData.data || [];
                employees = workersData.data || [];
                
                populateSupervisorDropdowns();
                showMainMenu();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data. Please check your connection and refresh the page.');
            }
        }

        function populateSupervisorDropdowns() {
            const startSelect = document.getElementById('startSupervisor');
            const endSelect = document.getElementById('endSupervisor');
            
            startSelect.innerHTML = '<option value="">Select Supervisor</option>';
            endSelect.innerHTML = '<option value="">Select Supervisor</option>';
            
            supervisors.forEach(supervisor => {
                const option1 = document.createElement('option');
                option1.value = supervisor.name;
                option1.textContent = supervisor.name;
                startSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = supervisor.name;
                option2.textContent = supervisor.name;
                endSelect.appendChild(option2);
            });
        }

        // Navigation functions
        function showMainMenu() {
            hideAllScreens();
            document.getElementById('mainMenu').classList.remove('hidden');
            resetData();
        }

        function showStartShift() {
            hideAllScreens();
            document.getElementById('startShiftLogin').classList.remove('hidden');
        }

        function showEndShift() {
            hideAllScreens();
            document.getElementById('endShiftLogin').classList.remove('hidden');
        }

        function showStartShiftEmployees() {
            hideAllScreens();
            document.getElementById('startShiftEmployees').classList.remove('hidden');
            loadEmployeeList();
            document.getElementById('shiftDate').value = new Date().toISOString().split('T')[0];
        }

        function showEndShiftWork() {
            hideAllScreens();
            document.getElementById('endShiftWork').classList.remove('hidden');
            if (workEntries.length === 0) {
                addWorkEntry();
            }
        }

        function showOvertimeInput() {
            hideAllScreens();
            document.getElementById('overtimeInput').classList.remove('hidden');
            loadOvertimeList();
        }

        function hideAllScreens() {
            const screens = ['loadingScreen', 'mainMenu', 'startShiftLogin', 'startShiftEmployees', 'endShiftLogin', 'endShiftWork', 'overtimeInput'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
        }

        function resetData() {
            currentSupervisor = "";
            selectedEmployees = [];
            workEntries = [];
            overtimeHours = {};
            document.getElementById('workEntries').innerHTML = '';
            document.getElementById('workSummary').classList.add('hidden');
        }

        // Login handling
        document.getElementById('startLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const supervisor = document.getElementById('startSupervisor').value;
            const password = document.getElementById('startPassword').value;
            
            const config = supervisors.find(s => s.name === supervisor && s.password === password);
            if (config) {
                currentSupervisor = supervisor;
                document.getElementById('lockedSupervisor').textContent = supervisor;
                showStartShiftEmployees();
            } else {
                alert('Invalid supervisor or password');
            }
        });

        document.getElementById('endLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const supervisor = document.getElementById('endSupervisor').value;
            const password = document.getElementById('endPassword').value;
            
            const config = supervisors.find(s => s.name === supervisor && s.password === password);
            if (config) {
                currentSupervisor = supervisor;
                document.getElementById('endLockedSupervisor').textContent = supervisor;
                showEndShiftWork();
            } else {
                alert('Invalid supervisor or password');
            }
        });

        // Employee list functions
        function loadEmployeeList() {
            const container = document.getElementById('employeeList');
            container.innerHTML = '';
            
            employees.forEach(employee => {
                const div = document.createElement('div');
                div.className = 'employee-item';
                div.innerHTML = `
                    <input type="checkbox" id="emp_${employee}" value="${employee}" onchange="updateSelectedEmployees()">
                    <label for="emp_${employee}">${employee}</label>
                `;
                container.appendChild(div);
            });
        }

        function updateSelectedEmployees() {
            selectedEmployees = [];
            const checkboxes = document.querySelectorAll('#employeeList input[type="checkbox"]:checked');
            checkboxes.forEach(cb => selectedEmployees.push(cb.value));
        }

        // Work entry functions
        function addWorkEntry() {
            const entryId = Date.now();
            const container = document.getElementById('workEntries');
            
            const entryDiv = document.createElement('div');
            entryDiv.className = 'work-entry';
            entryDiv.id = `entry_${entryId}`;
            
            entryDiv.innerHTML = `
                <div class="work-entry-header">
                    <strong>Work Entry ${workEntries.length + 1}</strong>
                    <button type="button" class="remove-entry" onclick="removeWorkEntry(${entryId})">Remove</button>
                </div>
                
                <div class="form-group">
                    <label>Work Type</label>
                    <select class="work-type" required>
                        <option value="">Select Type</option>
                        <option value="Erection">Erection</option>
                        <option value="Dismantling">Dismantling</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="description" rows="2" placeholder="Work description" required></textarea>
                </div>
                
                <div class="input-row-3">
                    <input type="number" class="length" placeholder="Length" step="0.01" required>
                    <input type="number" class="width" placeholder="Width" step="0.01" required>
                    <input type="number" class="height" placeholder="Height" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <input type="number" class="quantity" placeholder="Quantity" min="1" required>
                </div>
            `;
            
            container.appendChild(entryDiv);
            workEntries.push({ id: entryId });
        }

        function removeWorkEntry(entryId) {
            document.getElementById(`entry_${entryId}`).remove();
            workEntries = workEntries.filter(entry => entry.id !== entryId);
            updateWorkSummary();
        }

        function proceedToOvertime() {
            if (!validateWorkEntries()) {
                alert('Please fill in all work entry fields');
                return;
            }
            
            updateWorkSummary();
            showOvertimeInput();
        }

        function validateWorkEntries() {
            const entries = document.querySelectorAll('.work-entry');
            for (let entry of entries) {
                const inputs = entry.querySelectorAll('input, select, textarea');
                for (let input of inputs) {
                    if (!input.value.trim()) {
                        return false;
                    }
                }
            }
            return entries.length > 0;
        }

        function updateWorkSummary() {
            const tbody = document.querySelector('#summaryTable tbody');
            tbody.innerHTML = '';
            
            const entries = document.querySelectorAll('.work-entry');
            entries.forEach(entry => {
                const type = entry.querySelector('.work-type').value;
                const description = entry.querySelector('.description').value;
                const length = parseFloat(entry.querySelector('.length').value) || 0;
                const width = parseFloat(entry.querySelector('.width').value) || 0;
                const height = parseFloat(entry.querySelector('.height').value) || 0;
                const quantity = parseInt(entry.querySelector('.quantity').value) || 0;
                const volume = (length * width * height * quantity).toFixed(2);
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${type}</td>
                    <td>${description}</td>
                    <td>${length}×${width}×${height}</td>
                    <td>${quantity}</td>
                    <td>${volume}</td>
                `;
            });
            
            document.getElementById('workSummary').classList.remove('hidden');
        }

        // Overtime functions
        function loadOvertimeList() {
            const container = document.getElementById('overtimeList');
            container.innerHTML = '';
            
            selectedEmployees.forEach(employee => {
                const div = document.createElement('div');
                div.className = 'overtime-input';
                div.innerHTML = `
                    <span>${employee}</span>
                    <input type="number" min="0" max="12" step="0.5" value="0" 
                           onchange="updateOvertimeHours('${employee}', this.value)">
                `;
                container.appendChild(div);
                overtimeHours[employee] = 0;
            });
        }

        function updateOvertimeHours(employee, hours) {
            overtimeHours[employee] = parseFloat(hours) || 0;
        }

        // Submit functions
        async function submitStartShift() {
            if (selectedEmployees.length === 0) {
                alert('Please select at least one employee');
                return;
            }
            
            const date = document.getElementById('shiftDate').value;
            const report = generateStartShiftReport(date);
            
            try {
                // Save to Google Sheets via API
                await callAPI('saveStartShift', {
                    date: date,
                    supervisor: currentSupervisor,
                    workers: selectedEmployees
                });
                
                sendToWhatsApp(report);
                showMainMenu();
            } catch (error) {
                console.error('Error saving start shift:', error);
                alert('Error saving data. Please try again.');
            }
        }

        async function submitEndShift() {
            const date = new Date().toISOString().split('T')[0];
            const workData = collectWorkData();
            const report = generateEndShiftReport(workData);
            
            try {
                // Save to Google Sheets via API
                await callAPI('saveEndShift', {
                    date: date,
                    supervisor: currentSupervisor,
                    workData: workData,
                    workers: selectedEmployees,
                    overtimeHours: overtimeHours
                });
                
                sendToWhatsApp(report);
                showMainMenu();
            } catch (error) {
                console.error('Error saving end shift:', error);
                alert('Error saving data. Please try again.');
            }
        }

        function collectWorkData() {
            const workData = [];
            const entries = document.querySelectorAll('.work-entry');
            
            entries.forEach(entry => {
                const type = entry.querySelector('.work-type').value;
                const description = entry.querySelector('.description').value;
                const length = parseFloat(entry.querySelector('.length').value) || 0;
                const width = parseFloat(entry.querySelector('.width').value) || 0;
                const height = parseFloat(entry.querySelector('.height').value) || 0;
                const quantity = parseInt(entry.querySelector('.quantity').value) || 0;
                const volume = length * width * height * quantity;
                
                workData.push({
                    type,
                    description,
                    length,
                    width,
                    height,
                    quantity,
                    volume
                });
            });
            
            return workData;
        }

        function generateStartShiftReport(date) {
            return `${date}
Supervisor: ${currentSupervisor}
EMP: ${selectedEmployees.join(', ')}`;
        }

        function generateEndShiftReport(workData) {
            const date = new Date().toISOString().split('T')[0];
            
            // Calculate totals
            let totalErection = 0;
            let totalDismantling = 0;
            
            workData.forEach(work => {
                if (work.type === 'Erection') {
                    totalErection += work.volume;
                } else if (work.type === 'Dismantling') {
                    totalDismantling += work.volume;
                }
            });
            
            // Calculate manhours and productivity
            const regularHours = selectedEmployees.length * 8;
            const totalOvertimeHours = Object.values(overtimeHours).reduce((sum, hours) => sum + hours, 0);
            const totalManhours = regularHours + totalOvertimeHours;
            const productivity = ((totalErection + (totalDismantling / 2)) / totalManhours).toFixed(2);
            
            return `${date}
Supervisor: ${currentSupervisor}
Total Erection: ${totalErection.toFixed(2)}
Total Dismantling: ${totalDismantling.toFixed(2)}
Manhours: ${totalManhours}
Productivity: ${productivity}`;
        }

        function sendToWhatsApp(message) {
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'972769f6542b31b7',t:'MTc1NTc1MDgyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
