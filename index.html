<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance & Productivity Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f9f9f9; }
    h1 { margin-bottom: 10px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(250px,1fr)); gap: 16px; }
    .card { background:white; border-radius:12px; padding:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .calendar { display:grid; grid-template-columns: repeat(7,1fr); gap:4px; margin-top:8px; }
    .day { aspect-ratio:1/1; font-size:12px; border-radius:8px; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    .present { background:#a7f3d0; } /* green light */
    .ot { background:#16a34a; color:white; } /* dark green */
    .absent { background:#fecaca; } /* red */
    .header { font-weight:bold; margin-bottom:6px; }
    canvas { background:white; border-radius:12px; padding:8px; }
  </style>
</head>
<body>
  <h1>Attendance & Productivity Dashboard</h1>
  <p>Data live from Google Sheets (START SHIFT & ALL OVER)</p>

  <h2>Worker Attendance</h2>
  <div id="attendance" class="grid"></div>

  <h2>Daily Productivity</h2>
  <canvas id="productivityChart" height="120"></canvas>

<script>
const FILE_ID = "1I6gAbz5LMEr8im1mOw8CxMaAP41zXO-qhbEaU7dcqyQ";
const START_SHIFT_CSV = `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:csv&sheet=START%20SHIFT`;
const ALL_OVER_CSV = `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:csv&sheet=ALL%20OVER`;

function parseDate(d) {
  if (!d) return null;
  let tryFormats = [ "d MMMM yyyy", "dd-MM-yyyy", "d-M-yyyy" ];
  // Quick parse fallback
  let parts = d.split(/[- ]/);
  if (parts.length >= 3) {
    let maybe = new Date(d);
    if (!isNaN(maybe)) return maybe;
  }
  return new Date(d);
}

function fetchCSV(url) {
  return new Promise((resolve,reject)=>{
    Papa.parse(url,{
      download:true,
      header:true,
      skipEmptyLines:true,
      complete: res => resolve(res.data),
      error: reject
    })
  });
}

function makeCalendar(worker, records) {
  const div = document.createElement("div");
  div.className = "card";
  div.innerHTML = `<div class="header">${worker}</div><div class="calendar"></div>`;
  const cal = div.querySelector(".calendar");

  // Assume single month (use first record month)
  const dates = Object.keys(records).map(d=>new Date(d));
  if (!dates.length) return div;
  const ref = dates[0];
  const month = ref.getMonth();
  const year = ref.getFullYear();

  let start = new Date(year, month, 1);
  let end = new Date(year, month+1, 0);

  for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
    let key = d.toISOString().slice(0,10);
    let cell = document.createElement("div");
    cell.className = "day";
    cell.textContent = d.getDate();
    if (records[key]) {
      let ot = records[key];
      if (ot > 0) {
        cell.classList.add("day","ot");
        cell.innerHTML = d.getDate()+"<br>P"+ot;
      } else {
        cell.classList.add("day","present");
        cell.innerHTML = d.getDate()+"<br>P";
      }
    } else {
      cell.classList.add("day","absent");
    }
    cal.appendChild(cell);
  }
  return div;
}

async function init() {
  let attendance = await fetchCSV(START_SHIFT_CSV);
  let productivity = await fetchCSV(ALL_OVER_CSV);

  // Attendance index by worker
  let index = {};
  attendance.forEach(r=>{
    let name = r["EMP NAME"] || r["Emp Name"] || "";
    let date = parseDate(r.Date || r.DATE);
    if (!name || !date) return;
    let key = date.toISOString().slice(0,10);
    if (!index[name]) index[name] = {};
    index[name][key] = Number(r["OT HOURS"]||0);
  });

  let container = document.getElementById("attendance");
  Object.keys(index).sort().forEach(name=>{
    container.appendChild(makeCalendar(name,index[name]));
  });

  // Productivity chart
  let labels = [];
  let dataProd = [];
  productivity.forEach(r=>{
    let d = parseDate(r.DATE);
    if (!d) return;
    labels.push(d.toISOString().slice(0,10));
    dataProd.push(Number(r.PRODUCTIVITY||0));
  });

  new Chart(document.getElementById("productivityChart"), {
    type:'line',
    data:{
      labels:labels,
      datasets:[{
        label:'Productivity',
        data:dataProd,
        borderColor:'blue',
        backgroundColor:'rgba(0,0,255,0.2)'
      }]
    },
    options:{ responsive:true, maintainAspectRatio:false }
  });
}

init();
</script>
</body>
</html>