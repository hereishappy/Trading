<!DOCTYPE html> 
<html>
  <head>
    <meta charset="UTF-8">
    <title>ProScaffold - Shift Management System</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8f9fa;
        min-height: 100vh;
        padding: 20px 0;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        color: #2c3e50;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .header p {
        color: #6c757d;
        margin: 0;
      }

      .main-cards {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        max-width: 1200px;
        margin: 0 auto;
      }

      .card {
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border: 1px solid #e9ecef;
      }

      .card h3 {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
      }

      .card h3 i {
        margin-right: 10px;
        color: #007bff;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
      }

      .form-label i {
        margin-right: 8px;
        color: #007bff;
        width: 16px;
      }

      .form-control, .form-select {
        border: 1px solid #ced4da;
        border-radius: 6px;
        padding: 10px 15px;
        font-size: 14px;
      }

      .form-control:focus, .form-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      }

      .btn {
        border-radius: 6px;
        padding: 10px 20px;
        font-weight: 500;
        border: none;
      }

      .btn-primary {
        background-color: #007bff;
        color: white;
      }

      .btn-primary:hover {
        background-color: #0056b3;
      }

      .btn-success {
        background-color: #28a745;
        color: white;
      }

      .btn-success:hover {
        background-color: #1e7e34;
      }

      .workers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin: 15px 0;
      }

      .worker-item {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 12px;
        border: 1px solid #e9ecef;
      }

      .form-check-input:checked {
        background-color: #007bff;
        border-color: #007bff;
      }

      .table {
        background: white;
        border-radius: 6px;
        overflow: hidden;
        margin: 20px 0;
      }

      .table th {
        background-color: #007bff;
        color: white;
        font-weight: 500;
        border: none;
        padding: 12px;
      }

      .table td {
        padding: 10px 12px;
        border-color: #e9ecef;
      }

      .dimensions-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin: 15px 0;
      }

      .hide { 
        display: none !important; 
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #6c757d;
      }

      .error {
        background-color: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 6px;
        margin: 15px 0;
      }

      @media (max-width: 768px) {
        .main-cards {
          grid-template-columns: 1fr;
          gap: 20px;
          padding: 0 15px;
        }
        
        .dimensions-row {
          grid-template-columns: repeat(2, 1fr);
        }
        
        .workers-grid {
          grid-template-columns: 1fr;
        }

        .card {
          padding: 20px;
        }
      }
    </style>
    <script>
      let appConfig = {};
      let entries = [];
      let endShiftOts = {};

      // Configuration for GitHub deployment
      const CONFIG = {
        // IMPORTANT: Replace this URL with your deployed Google Apps Script Web App URL
        apiEndpoint: 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec',
        
        // Set to false for GitHub deployment (no demo mode in production)
        demoMode: false,
        
        // Demo data for local testing only
        demoData: {
          supervisors: ['John Smith', 'Sarah Johnson', 'Mike Wilson'],
          workers: ['Worker 1', 'Worker 2', 'Worker 3', 'Worker 4', 'Worker 5'],
          credentials: {
            'John Smith': '1234',
            'Sarah Johnson': '5678', 
            'Mike Wilson': '9012'
          }
        }
      };

      window.onload = function() {
        loadConfigFromAPI();
      };

      async function loadConfigFromAPI() {
        if (CONFIG.demoMode) {
          // Use demo data for testing
          cfgLoaded(CONFIG.demoData);
          return;
        }

        // Show loading indicator
        showLoading('Loading configuration...');

        try {
          const response = await fetch(CONFIG.apiEndpoint + '?action=getAppData', {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const data = await response.json();
          
          if (data.error) {
            throw new Error(data.error);
          }
          
          cfgLoaded(data);
          hideLoading();
        } catch (error) {
          console.error('Failed to load configuration:', error);
          showError('Failed to connect to server. Please check your configuration and try again.');
        }
      }

      function showLoading(message) {
        document.body.innerHTML = `
          <div class="container">
            <div class="loading">
              <i class="fas fa-spinner fa-spin fa-2x"></i>
              <p class="mt-3">${message}</p>
            </div>
          </div>
        `;
      }

      function hideLoading() {
        // Loading will be replaced by the main content when cfgLoaded is called
      }

      function showError(message) {
        document.body.innerHTML = `
          <div class="container">
            <div class="error">
              <h4><i class="fas fa-exclamation-triangle"></i> Connection Error</h4>
              <p>${message}</p>
              <button class="btn btn-primary" onclick="window.location.reload()">
                <i class="fas fa-redo"></i> Retry
              </button>
            </div>
          </div>
        `;
      }

      function cfgLoaded(cfg) {
        appConfig = cfg;
        
        // Restore the main HTML content
        document.body.innerHTML = `
          <div class="container-fluid">
            <!-- Simple Header -->
            <div class="header">
              <h1><i class="fas fa-hard-hat"></i> ProScaffold</h1>
              <p>Shift Management System</p>
            </div>

            <!-- Main 2-Card Layout -->
            <div class="main-cards">
              
              <!-- LEFT CARD - Start Shift -->
              <div class="card">
                <!-- Start Shift Login -->
                <div id="start-shift-login">
                  <h3><i class="fas fa-play-circle"></i> Start Shift</h3>
                  <div class="form-group">
                    <label class="form-label" for="start-login-supervisor">
                      <i class="fas fa-user-tie"></i>Supervisor
                    </label>
                    <select id="start-login-supervisor" class="form-select"></select>
                  </div>
                  <div class="form-group">
                    <label class="form-label" for="start-login-passcode">
                      <i class="fas fa-lock"></i>4-Digit Passcode
                    </label>
                    <input type="password" maxlength="4" id="start-login-passcode" class="form-control" placeholder="••••">
                  </div>
                  <button class="btn btn-primary w-100" onclick="startLogin()">
                    <i class="fas fa-sign-in-alt me-2"></i>Login to Start Shift
                  </button>
                </div>

                <!-- Start Shift Form -->
                <div id="start-shift-form" class="hide">
                  <h3><i class="fas fa-play-circle"></i> Start Shift Entry</h3>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-group">
                        <label class="form-label">
                          <i class="fas fa-user-tie"></i>Supervisor
                        </label>
                        <input type="text" id="start-supervisor-name" class="form-control" readonly>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label class="form-label">
                          <i class="fas fa-calendar"></i>Date
                        </label>
                        <input type="date" id="start-date-input" class="form-control">
                      </div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-label">
                      <i class="fas fa-users"></i>Select Workers for This Shift
                    </label>
                    <div class="workers-grid" id="start-workers-list"></div>
                  </div>
                  <button class="btn btn-success w-100" onclick="submitStartShift()">
                    <i class="fas fa-save me-2"></i>Save Start Shift
                  </button>
                </div>
              </div>

              <!-- RIGHT CARD - End Shift -->
              <div class="card">
                <!-- End Shift Login -->
                <div id="end-shift-login">
                  <h3><i class="fas fa-stop-circle"></i> End Shift</h3>
                  <div class="form-group">
                    <label class="form-label" for="end-login-supervisor">
                      <i class="fas fa-user-tie"></i>Supervisor
                    </label>
                    <select id="end-login-supervisor" class="form-select"></select>
                  </div>
                  <div class="form-group">
                    <label class="form-label" for="end-login-passcode">
                      <i class="fas fa-lock"></i>4-Digit Passcode
                    </label>
                    <input type="password" maxlength="4" id="end-login-passcode" class="form-control" placeholder="••••">
                  </div>
                  <button class="btn btn-primary w-100" onclick="endLogin()">
                    <i class="fas fa-sign-out-alt me-2"></i>Login to End Shift
                  </button>
                </div>

                <!-- End Shift Entry -->
                <div id="end-entry-form" class="hide">
                  <h3><i class="fas fa-clipboard-list"></i> End Shift Entry</h3>
                  <div class="form-group">
                    <label class="form-label">
                      <i class="fas fa-user-tie"></i>Supervisor: <span id="end-supervisor-name" class="text-primary"></span>
                    </label>
                  </div>
                  <div class="form-group">
                    <label class="form-label">
                      <i class="fas fa-calendar"></i>Date
                    </label>
                    <input type="date" id="end-date-input" class="form-control">
                  </div>
                  
                  <div class="row">
                    <div class="col-md-4">
                      <div class="form-group">
                        <label class="form-label">
                          <i class="fas fa-tags"></i>Type
                        </label>
                        <select id="end-type" class="form-select">
                          <option value="">Select Type</option>
                          <option value="Erection">Erection</option>
                          <option value="Dismantling">Dismantling</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-md-8">
                      <div class="form-group">
                        <label class="form-label">
                          <i class="fas fa-edit"></i>Description
                        </label>
                        <input type="text" id="end-desc" class="form-control" placeholder="Enter work description">
                      </div>
                    </div>
                  </div>

                  <div class="dimensions-row">
                    <div class="form-group">
                      <label class="form-label">Length</label>
                      <input type="number" id="end-length" class="form-control" placeholder="0">
                    </div>
                    <div class="form-group">
                      <label class="form-label">Width</label>
                      <input type="number" id="end-width" class="form-control" placeholder="0">
                    </div>
                    <div class="form-group">
                      <label class="form-label">Height</label>
                      <input type="number" id="end-height" class="form-control" placeholder="0">
                    </div>
                    <div class="form-group">
                      <label class="form-label">Quantity</label>
                      <input type="number" id="end-qty" class="form-control" placeholder="0">
                    </div>
                  </div>

                  <button class="btn btn-success mb-3" onclick="addEndShiftEntry()">
                    <i class="fas fa-plus me-2"></i>Add Entry
                  </button>

                  <table class="table table-sm" id="end-entries-table"></table>
                  
                  <button class="btn btn-primary w-100" onclick="submitEndEntries()">
                    <i class="fas fa-arrow-right me-2"></i>Next: Overtime Entry
                  </button>
                </div>

                <!-- Overtime Entry -->
                <div id="end-ot-form" class="hide">
                  <h3><i class="fas fa-clock"></i> Overtime Hours Entry</h3>
                  <p class="text-muted mb-3">Enter overtime hours for each worker (0-12 hours)</p>
                  <table class="table table-sm" id="end-ot-workers"></table>
                  <button class="btn btn-success w-100" onclick="submitEndAndClose()">
                    <i class="fas fa-check-circle me-2"></i>Submit & Close Shift
                  </button>
                </div>
              </div>

            </div>
          </div>
        `;
        
        // Initialize the interface
        populateSupervisorDropdown('start-login-supervisor');
        populateSupervisorDropdown('end-login-supervisor');
        populateWorkersList();
      }

      function populateSupervisorDropdown(id) {
        const el = document.getElementById(id);
        el.innerHTML = "<option value=''>Select supervisor</option>";
        appConfig.supervisors.forEach(sv => {
          el.innerHTML += `<option value="${sv}">${sv}</option>`;
        });
      }

      function populateWorkersList() {
        const wl = document.getElementById('start-workers-list');
        if (!wl) return;
        wl.innerHTML = "";
        appConfig.workers.forEach(w => {
          wl.innerHTML += `<div class="worker-item">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="${w}" id="chk-${w.replace(/\s+/g,'-')}" name="workers">
                  <label class="form-check-label" for="chk-${w.replace(/\s+/g,'-')}">${w}</label>
                </div>
              </div>`;
        });
      }

      async function startLogin() {
        const supervisor = document.getElementById('start-login-supervisor').value;
        const passcode = document.getElementById('start-login-passcode').value;
        if (!supervisor || passcode.length !== 4) return alert('Fill all fields with valid data.');
        
        const isValid = await validateSupervisorLogin(supervisor, passcode);
        if(isValid){
          document.getElementById('start-shift-login').classList.add('hide');
          showStartShiftCard(supervisor);
        } else alert('Invalid login or passcode. Try again.');
      }

      async function endLogin() {
        const supervisor = document.getElementById('end-login-supervisor').value;
        const passcode = document.getElementById('end-login-passcode').value;
        if (!supervisor || passcode.length !== 4) return alert('Fill all fields with valid data.');
        
        const isValid = await validateSupervisorLogin(supervisor, passcode);
        if(isValid){
          document.getElementById('end-shift-login').classList.add('hide');
          showEndShiftEntry(supervisor);
        } else alert('Invalid login or passcode. Try again.');
      }

      async function validateSupervisorLogin(supervisor, passcode) {
        if (CONFIG.demoMode) {
          return CONFIG.demoData.credentials[supervisor] === passcode;
        }
        
        try {
          const response = await fetch(CONFIG.apiEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'validateSupervisorLogin',
              supervisor: supervisor,
              passcode: passcode
            })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const result = await response.json();
          return result.valid;
        } catch (error) {
          console.error('Login validation failed:', error);
          alert('Connection error. Please check your internet connection and try again.');
          return false;
        }
      }

      function showStartShiftCard(supervisor) {
        document.getElementById('start-shift-form').classList.remove('hide');
        document.getElementById('start-supervisor-name').value = supervisor;
        document.getElementById('start-date-input').value = new Date().toISOString().slice(0,10);
        populateWorkersList();
      }

      async function submitStartShift() {
        const supervisor = document.getElementById('start-supervisor-name').value;
        const date = document.getElementById('start-date-input').value;
        const workerInputs = document.querySelectorAll('input[name="workers"]:checked');
        const selected = Array.from(workerInputs).map(input=>input.value);
        if (!supervisor || !date || selected.length<1) return alert("Select at least one worker!");
        
        const success = await saveStartShift({date, supervisor, workers: selected});
        if (success) {
          alert("Start shift saved successfully.");
          window.location.reload();
        }
      }

      async function saveStartShift(data) {
        if (CONFIG.demoMode) {
          console.log('Demo mode - would save start shift:', data);
          return true;
        }
        
        try {
          const response = await fetch(CONFIG.apiEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'saveStartShift',
              data: data
            })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const result = await response.json();
          return result.success;
        } catch (error) {
          console.error('Failed to save start shift:', error);
          alert('Failed to save start shift. Please check your connection and try again.');
          return false;
        }
      }

      function showEndShiftEntry(supervisor) {
        document.getElementById('end-entry-form').classList.remove('hide');
        document.getElementById('end-supervisor-name').innerText = supervisor;
        document.getElementById('end-date-input').value = new Date().toISOString().slice(0,10);
        entries = [];
        renderEndShiftEntries();
      }

      function addEndShiftEntry() {
        const type = document.getElementById('end-type').value;
        const desc = document.getElementById('end-desc').value.trim();
        const l = Number(document.getElementById('end-length').value);
        const w = Number(document.getElementById('end-width').value);
        const h = Number(document.getElementById('end-height').value);
        const qty = Number(document.getElementById('end-qty').value);
        if (!type || !desc || l<=0 || w<=0 || h<=0 || qty<=0) return alert('All fields required, no negatives or zeros!');
        const volume = l*w*h*qty;
        entries.push({type, description: desc, length: l, width:w, height:h, quantity:qty, volume});
        renderEndShiftEntries();
        document.getElementById('end-desc').value='';
        ['end-length','end-width','end-height','end-qty'].forEach(id=>document.getElementById(id).value='');
      }

      function renderEndShiftEntries(){
        const tbl = document.getElementById('end-entries-table');
        tbl.innerHTML = '';
        if (!entries.length) return;
        tbl.innerHTML = `
          <thead>
            <tr><th>#</th><th>Type</th><th>Description</th><th>Dimensions</th><th>Qty</th><th>Volume</th></tr>
          </thead>
          <tbody>
            ${entries.map((e,i)=>`<tr>
            <td>${i+1}</td>
            <td><span class="badge bg-primary">${e.type}</span></td>
            <td>${e.description}</td>
            <td>${e.length}×${e.width}×${e.height}</td>
            <td>${e.quantity}</td>
            <td><strong>${e.volume}</strong></td>
            </tr>`).join('')}
          </tbody>`;
      }

      function submitEndEntries() {
        if (!entries.length) return alert('Add at least one entry!');
        document.getElementById('end-entry-form').classList.add('hide');
        document.getElementById('end-ot-form').classList.remove('hide');
        const wl = document.getElementById('end-ot-workers');
        wl.innerHTML = '<thead><tr><th>Worker</th><th>Overtime Hours</th></tr></thead><tbody>';
        appConfig.workers.forEach(w=>{
          wl.innerHTML += `<tr>
              <td><strong>${w}</strong></td>
              <td><input class="form-control" type="number" min="0" max="12" value="0" id="ot-${w.replace(/\s+/g,'-')}"></td>
          </tr>`;
        });
        wl.innerHTML += '</tbody>';
      }

      async function submitEndAndClose() {
        const supervisor = document.getElementById('end-supervisor-name').innerText;
        const date = document.getElementById('end-date-input').value;
        endShiftOts = {};
        appConfig.workers.forEach(w=>{
          const otVal = Number(document.getElementById(`ot-${w.replace(/\s+/g,'-')}`).value)||0;
          endShiftOts[w]=otVal;
        });

        try {
          const success = await saveEndShift({
            date, supervisor,
            entries, overtimesObj:endShiftOts
          });
          
          if (success) {
            alert("End shift saved successfully.");
            window.location.reload();
          }
        } catch (error) {
          alert('Error: ' + error.message);
        }
      }

      async function saveEndShift(data) {
        if (CONFIG.demoMode) {
          console.log('Demo mode - would save end shift:', data);
          return true;
        }
        
        try {
          const response = await fetch(CONFIG.apiEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'saveEndShift',
              data: data
            })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: Failed to save end shift`);
          }
          
          const result = await response.json();
          if (result.error) {
            throw new Error(result.error);
          }
          
          return result.success;
        } catch (error) {
          console.error('Failed to save end shift:', error);
          throw error;
        }
      }

      function logout() { window.location.reload(); }
    </script>
  </head>
  <body>
    <!-- Content will be loaded dynamically -->
    <div class="loading">
      <i class="fas fa-spinner fa-spin fa-2x"></i>
      <p class="mt-3">Initializing...</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
