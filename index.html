<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker Dashboard - Attendance & Productivity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .calendar-day {
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .present { background: linear-gradient(135deg, #10b981, #059669); }
        .absent { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <h1 class="text-xl font-semibold text-gray-900">Worker Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Refresh Data
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8">
                <button id="attendanceTab" class="tab-button border-b-2 border-blue-500 text-blue-600 py-2 px-1 text-sm font-medium">
                    Attendance Calendar
                </button>
                <button id="productivityTab" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 text-sm font-medium">
                    Productivity Tracker
                </button>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="loading-shimmer w-16 h-16 rounded-full mx-auto mb-4"></div>
            <p class="text-gray-600">Loading dashboard data...</p>
        </div>

        <!-- Attendance View -->
        <div id="attendanceView" class="hidden fade-in">
            <div class="mb-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Worker Attendance</h2>
                <div class="flex items-center space-x-4">
                    <select id="monthSelect" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="2024-01">January 2024</option>
                        <option value="2024-02">February 2024</option>
                        <option value="2024-03">March 2024</option>
                        <option value="2024-04">April 2024</option>
                        <option value="2024-05">May 2024</option>
                        <option value="2024-06">June 2024</option>
                        <option value="2024-07">July 2024</option>
                        <option value="2024-08" selected>August 2024</option>
                        <option value="2024-09">September 2024</option>
                        <option value="2024-10">October 2024</option>
                        <option value="2024-11">November 2024</option>
                        <option value="2024-12">December 2024</option>
                    </select>
                </div>
            </div>
            
            <!-- Legend -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
                <h3 class="text-sm font-medium text-gray-900 mb-3">Legend</h3>
                <div class="flex flex-wrap gap-4 text-sm">
                    <div class="flex items-center">
                        <div class="w-4 h-4 present rounded mr-2"></div>
                        <span>Present</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 absent rounded mr-2"></div>
                        <span>Absent</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 present rounded mr-2"></div>
                        <span class="text-xs bg-blue-100 text-blue-800 px-1 rounded">P4</span>
                        <span class="ml-1">Present + 4hr OT</span>
                    </div>
                </div>
            </div>

            <!-- Worker Cards Grid -->
            <div id="workerGrid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                <!-- Worker cards will be populated here -->
            </div>
        </div>

        <!-- Productivity View -->
        <div id="productivityView" class="hidden fade-in">
            <div class="mb-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Productivity Tracker</h2>
                <div class="flex items-center space-x-4">
                    <input type="date" id="dateFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                    <button id="clearFilter" class="text-gray-500 hover:text-gray-700 text-sm">Clear Filter</button>
                </div>
            </div>

            <!-- Productivity Table -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Erection</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dismantling</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equivalent</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Man Hours</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">OT Hours</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Productivity</th>
                            </tr>
                        </thead>
                        <tbody id="productivityTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Productivity data will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Summary Footer -->
                <div id="productivitySummary" class="bg-gray-50 px-6 py-4 border-t border-gray-200">
                    <!-- Summary will be populated here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Tooltip -->
    <div id="tooltip" class="absolute z-50 bg-gray-900 text-white text-xs rounded-lg px-3 py-2 opacity-0 pointer-events-none transition-opacity duration-200 max-w-xs">
        <div id="tooltipContent"></div>
        <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900"></div>
    </div>

    <script>
        // Global data storage
        let attendanceData = [];
        let productivityData = [];
        let currentView = 'attendance';

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Tab switching
            document.getElementById('attendanceTab').addEventListener('click', () => switchTab('attendance'));
            document.getElementById('productivityTab').addEventListener('click', () => switchTab('productivity'));
            
            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', loadData);
            
            // Month selector
            document.getElementById('monthSelect').addEventListener('change', renderAttendanceView);
            
            // Date filter
            document.getElementById('dateFilter').addEventListener('change', renderProductivityView);
            document.getElementById('clearFilter').addEventListener('click', () => {
                document.getElementById('dateFilter').value = '';
                renderProductivityView();
            });
        }

        async function loadData() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('attendanceView').classList.add('hidden');
            document.getElementById('productivityView').classList.add('hidden');

            try {
                // Try to load real data first with proper CSV export URLs
                const attendanceResponse = await fetch('https://docs.google.com/spreadsheets/d/1I6gAbz5LMEr8im1mOw8CxMaAP41zXO-qhbEaU7dcqyQ/export?format=csv&gid=0', {
                    mode: 'cors',
                    headers: {
                        'Accept': 'text/csv,text/plain,*/*'
                    }
                });
                
                if (!attendanceResponse.ok) {
                    throw new Error('Failed to fetch attendance data');
                }
                
                const attendanceText = await attendanceResponse.text();
                attendanceData = parseCSV(attendanceText);

                // For the second sheet, we need to find the correct gid (sheet ID)
                // Let's try a few common approaches
                let productivityText = '';
                const productivityUrls = [
                    'https://docs.google.com/spreadsheets/d/1I6gAbz5LMEr8im1mOw8CxMaAP41zXO-qhbEaU7dcqyQ/export?format=csv&gid=1',
                    'https://docs.google.com/spreadsheets/d/1I6gAbz5LMEr8im1mOw8CxMaAP41zXO-qhbEaU7dcqyQ/export?format=csv&gid=2',
                    'https://docs.google.com/spreadsheets/d/1I6gAbz5LMEr8im1mOw8CxMaAP41zXO-qhbEaU7dcqyQ/export?format=csv'
                ];
                
                let productivityLoaded = false;
                for (const url of productivityUrls) {
                    try {
                        const productivityResponse = await fetch(url, {
                            mode: 'cors',
                            headers: {
                                'Accept': 'text/csv,text/plain,*/*'
                            }
                        });
                        
                        if (productivityResponse.ok) {
                            productivityText = await productivityResponse.text();
                            productivityData = parseCSV(productivityText);
                            productivityLoaded = true;
                            break;
                        }
                    } catch (e) {
                        continue;
                    }
                }
                
                if (!productivityLoaded) {
                    throw new Error('Failed to fetch productivity data from all attempted URLs');
                }

                // Show success message
                showNotification('✅ Data loaded successfully from Google Sheets!', 'success');

            } catch (error) {
                console.error('Error loading live data:', error);
                
                // Load sample data as fallback
                loadSampleData();
                showNotification('⚠️ Using sample data - Google Sheets connection failed', 'warning');
            }

            // Render current view
            if (currentView === 'attendance') {
                renderAttendanceView();
            } else {
                renderProductivityView();
            }

            document.getElementById('loadingState').classList.add('hidden');
        }

        function loadSampleData() {
            // Sample attendance data
            attendanceData = [
                { 'Date': '2024-08-01', 'Supervisor': 'MAHENDRA KUMAR', 'EMP NAME': 'AMAN KUMAR', 'Shift Hours': '8', 'OT HOURS': '2' },
                { 'Date': '2024-08-02', 'Supervisor': 'MAHENDRA KUMAR', 'EMP NAME': 'AMAN KUMAR', 'Shift Hours': '8', 'OT HOURS': '4' },
                { 'Date': '2024-08-03', 'Supervisor': 'MAHENDRA KUMAR', 'EMP NAME': 'AMAN KUMAR', 'Shift Hours': '8', 'OT HOURS': '0' },
                { 'Date': '2024-08-05', 'Supervisor': 'MAHENDRA KUMAR', 'EMP NAME': 'AMAN KUMAR', 'Shift Hours': '8', 'OT HOURS': '6' },
                { 'Date': '2024-08-06', 'Supervisor': 'MAHENDRA KUMAR', 'EMP NAME': 'AMAN KUMAR', 'Shift Hours': '8', 'OT HOURS': '0' },
                { 'Date': '2024-08-07', 'Supervisor': 'MAHENDRA KUMAR', 'EMP NAME': 'AMAN KUMAR', 'Shift Hours': '8', 'OT HOURS': '0' },
                { 'Date': '2024-08-01', 'Supervisor': 'RAJESH SINGH', 'EMP NAME': 'PRIYA SHARMA', 'Shift Hours': '8', 'OT HOURS': '3' },
                { 'Date': '2024-08-02', 'Supervisor': 'RAJESH SINGH', 'EMP NAME': 'PRIYA SHARMA', 'Shift Hours': '8', 'OT HOURS': '0' },
                { 'Date': '2024-08-04', 'Supervisor': 'RAJESH SINGH', 'EMP NAME': 'PRIYA SHARMA', 'Shift Hours': '8', 'OT HOURS': '5' },
                { 'Date': '2024-08-05', 'Supervisor': 'RAJESH SINGH', 'EMP NAME': 'PRIYA SHARMA', 'Shift Hours': '8', 'OT HOURS': '2' },
                { 'Date': '2024-08-06', 'Supervisor': 'RAJESH SINGH', 'EMP NAME': 'PRIYA SHARMA', 'Shift Hours': '8', 'OT HOURS': '4' },
                { 'Date': '2024-08-01', 'Supervisor': 'SURESH PATEL', 'EMP NAME': 'VIKRAM GUPTA', 'Shift Hours': '8', 'OT HOURS': '1' },
                { 'Date': '2024-08-02', 'Supervisor': 'SURESH PATEL', 'EMP NAME': 'VIKRAM GUPTA', 'Shift Hours': '8', 'OT HOURS': '0' },
                { 'Date': '2024-08-03', 'Supervisor': 'SURESH PATEL', 'EMP NAME': 'VIKRAM GUPTA', 'Shift Hours': '8', 'OT HOURS': '2' },
                { 'Date': '2024-08-04', 'Supervisor': 'SURESH PATEL', 'EMP NAME': 'VIKRAM GUPTA', 'Shift Hours': '8', 'OT HOURS': '4' },
                { 'Date': '2024-08-07', 'Supervisor': 'SURESH PATEL', 'EMP NAME': 'VIKRAM GUPTA', 'Shift Hours': '8', 'OT HOURS': '0' }
            ];

            // Sample productivity data
            productivityData = [
                { 'DATE': '2024-08-01', 'ERECTION': '12', 'DISMANTLING': '8', 'EQUILVENT': '20', 'MANHOURS': '64', 'OT HOURS': '6', 'PRODUCTIVITY': '0.31' },
                { 'DATE': '2024-08-02', 'ERECTION': '15', 'DISMANTLING': '5', 'EQUILVENT': '20', 'MANHOURS': '72', 'OT HOURS': '4', 'PRODUCTIVITY': '0.28' },
                { 'DATE': '2024-08-03', 'ERECTION': '10', 'DISMANTLING': '10', 'EQUILVENT': '20', 'MANHOURS': '56', 'OT HOURS': '2', 'PRODUCTIVITY': '0.36' },
                { 'DATE': '2024-08-04', 'ERECTION': '18', 'DISMANTLING': '2', 'EQUILVENT': '20', 'MANHOURS': '80', 'OT HOURS': '9', 'PRODUCTIVITY': '0.25' },
                { 'DATE': '2024-08-05', 'ERECTION': '14', 'DISMANTLING': '6', 'EQUILVENT': '20', 'MANHOURS': '68', 'OT HOURS': '8', 'PRODUCTIVITY': '0.29' },
                { 'DATE': '2024-08-06', 'ERECTION': '16', 'DISMANTLING': '4', 'EQUILVENT': '20', 'MANHOURS': '64', 'OT HOURS': '4', 'PRODUCTIVITY': '0.31' },
                { 'DATE': '2024-08-07', 'ERECTION': '13', 'DISMANTLING': '7', 'EQUILVENT': '20', 'MANHOURS': '56', 'OT HOURS': '0', 'PRODUCTIVITY': '0.36' }
            ];
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-white text-sm font-medium transition-all duration-300 transform translate-x-full`;
            
            if (type === 'success') {
                notification.classList.add('bg-green-600');
            } else if (type === 'warning') {
                notification.classList.add('bg-yellow-600');
            } else if (type === 'error') {
                notification.classList.add('bg-red-600');
            } else {
                notification.classList.add('bg-blue-600');
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 4000);
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.replace(/"/g, '').trim());
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] || '';
                });
                return obj;
            });
        }

        function switchTab(tab) {
            currentView = tab;
            
            // Update tab styles
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            if (tab === 'attendance') {
                document.getElementById('attendanceTab').classList.add('border-blue-500', 'text-blue-600');
                document.getElementById('attendanceTab').classList.remove('border-transparent', 'text-gray-500');
                document.getElementById('attendanceView').classList.remove('hidden');
                document.getElementById('productivityView').classList.add('hidden');
                renderAttendanceView();
            } else {
                document.getElementById('productivityTab').classList.add('border-blue-500', 'text-blue-600');
                document.getElementById('productivityTab').classList.remove('border-transparent', 'text-gray-500');
                document.getElementById('productivityView').classList.remove('hidden');
                document.getElementById('attendanceView').classList.add('hidden');
                renderProductivityView();
            }
        }

        function renderAttendanceView() {
            const selectedMonth = document.getElementById('monthSelect').value;
            const [year, month] = selectedMonth.split('-');
            
            // Group attendance data by worker
            const workerData = {};
            attendanceData.forEach(record => {
                if (record['EMP NAME'] && record['Date']) {
                    const empName = record['EMP NAME'];
                    if (!workerData[empName]) {
                        workerData[empName] = {
                            name: empName,
                            supervisor: record['Supervisor'] || 'N/A',
                            attendance: {}
                        };
                    }
                    
                    const date = new Date(record['Date']);
                    if (date.getFullYear() == year && (date.getMonth() + 1) == parseInt(month)) {
                        const dayKey = date.getDate();
                        workerData[empName].attendance[dayKey] = {
                            present: true,
                            supervisor: record['Supervisor'] || 'N/A',
                            shiftHours: parseFloat(record['Shift Hours']) || 0,
                            otHours: parseFloat(record['OT HOURS']) || 0
                        };
                    }
                }
            });

            // Generate calendar for each worker
            const workerGrid = document.getElementById('workerGrid');
            workerGrid.innerHTML = '';

            Object.values(workerData).forEach(worker => {
                const workerCard = createWorkerCard(worker, year, month);
                workerGrid.appendChild(workerCard);
            });
        }

        function createWorkerCard(worker, year, month) {
            const daysInMonth = new Date(year, month, 0).getDate();
            const firstDay = new Date(year, month - 1, 1).getDay();
            
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-sm border border-gray-200 p-6';
            
            card.innerHTML = `
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">${worker.name}</h3>
                    <p class="text-sm text-gray-600">Supervisor: ${worker.supervisor}</p>
                </div>
                
                <div class="calendar">
                    <div class="grid grid-cols-7 gap-1 mb-2 text-xs font-medium text-gray-500">
                        <div class="text-center py-1">Su</div>
                        <div class="text-center py-1">Mo</div>
                        <div class="text-center py-1">Tu</div>
                        <div class="text-center py-1">We</div>
                        <div class="text-center py-1">Th</div>
                        <div class="text-center py-1">Fr</div>
                        <div class="text-center py-1">Sa</div>
                    </div>
                    <div class="grid grid-cols-7 gap-1" id="calendar-${worker.name.replace(/\s+/g, '')}">
                        ${generateCalendarDays(worker, daysInMonth, firstDay)}
                    </div>
                </div>
            `;
            
            return card;
        }

        function generateCalendarDays(worker, daysInMonth, firstDay) {
            let html = '';
            
            // Empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="h-10"></div>';
            }
            
            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const attendance = worker.attendance[day];
                let dayClass = 'calendar-day h-10 rounded flex flex-col items-center justify-center text-xs font-medium cursor-pointer relative';
                let content = day.toString();
                let otTag = '';
                
                if (attendance && attendance.present) {
                    dayClass += ' present text-white';
                    if (attendance.otHours >= 4) {
                        otTag = '<div class="absolute -bottom-1 text-xs bg-blue-100 text-blue-800 px-1 rounded" style="font-size: 8px;">P4</div>';
                    }
                } else {
                    dayClass += ' absent text-white';
                }
                
                html += `
                    <div class="${dayClass}" 
                         onmouseover="showTooltip(event, '${worker.name}', ${day}, ${JSON.stringify(attendance).replace(/"/g, '&quot;')})"
                         onmouseout="hideTooltip()">
                        ${content}
                        ${otTag}
                    </div>
                `;
            }
            
            return html;
        }

        function renderProductivityView() {
            const dateFilter = document.getElementById('dateFilter').value;
            let filteredData = productivityData;
            
            if (dateFilter) {
                filteredData = productivityData.filter(record => {
                    const recordDate = new Date(record['DATE']);
                    const filterDate = new Date(dateFilter);
                    return recordDate.toDateString() === filterDate.toDateString();
                });
            }
            
            const tbody = document.getElementById('productivityTableBody');
            tbody.innerHTML = '';
            
            let totals = {
                erection: 0,
                dismantling: 0,
                equivalent: 0,
                manhours: 0,
                otHours: 0,
                productivity: 0
            };
            
            filteredData.forEach(record => {
                const row = document.createElement('tr');
                const isProductive = parseFloat(record['PRODUCTIVITY']) > 0;
                
                if (isProductive) {
                    row.className = 'bg-green-50 hover:bg-green-100';
                } else {
                    row.className = 'bg-gray-50 hover:bg-gray-100';
                }
                
                // Add to totals
                totals.erection += parseFloat(record['ERECTION']) || 0;
                totals.dismantling += parseFloat(record['DISMANTLING']) || 0;
                totals.equivalent += parseFloat(record['EQUILVENT']) || 0;
                totals.manhours += parseFloat(record['MANHOURS']) || 0;
                totals.otHours += parseFloat(record['OT HOURS']) || 0;
                totals.productivity += parseFloat(record['PRODUCTIVITY']) || 0;
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(record['DATE'])}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record['ERECTION'] || '0'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record['DISMANTLING'] || '0'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record['EQUILVENT'] || '0'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record['MANHOURS'] || '0'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record['OT HOURS'] || '0'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${isProductive ? 'text-green-600' : 'text-gray-400'}">${record['PRODUCTIVITY'] || '0'}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Update summary
            const summary = document.getElementById('productivitySummary');
            const avgProductivity = filteredData.length > 0 ? (totals.productivity / filteredData.length).toFixed(2) : '0';
            
            summary.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-gray-900">Total Records:</span>
                        <span class="text-gray-600 ml-1">${filteredData.length}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-900">Total Erection:</span>
                        <span class="text-gray-600 ml-1">${totals.erection.toFixed(1)}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-900">Total Dismantling:</span>
                        <span class="text-gray-600 ml-1">${totals.dismantling.toFixed(1)}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-900">Total Equivalent:</span>
                        <span class="text-gray-600 ml-1">${totals.equivalent.toFixed(1)}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-900">Total Man Hours:</span>
                        <span class="text-gray-600 ml-1">${totals.manhours.toFixed(1)}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-900">Total OT Hours:</span>
                        <span class="text-gray-600 ml-1">${totals.otHours.toFixed(1)}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-900">Avg Productivity:</span>
                        <span class="text-green-600 ml-1 font-semibold">${avgProductivity}</span>
                    </div>
                </div>
            `;
        }

        function showTooltip(event, workerName, day, attendance) {
            const tooltip = document.getElementById('tooltip');
            const tooltipContent = document.getElementById('tooltipContent');
            
            if (attendance && attendance !== 'null') {
                const data = JSON.parse(attendance.replace(/&quot;/g, '"'));
                tooltipContent.innerHTML = `
                    <div class="font-semibold">${workerName}</div>
                    <div class="text-xs mt-1">
                        <div>Date: ${day}</div>
                        <div>Supervisor: ${data.supervisor}</div>
                        <div>Shift Hours: ${data.shiftHours}</div>
                        <div>OT Hours: ${data.otHours}</div>
                        ${data.otHours >= 4 ? '<div class="text-blue-300">🏆 4+ Hour OT</div>' : ''}
                    </div>
                `;
            } else {
                tooltipContent.innerHTML = `
                    <div class="font-semibold">${workerName}</div>
                    <div class="text-xs mt-1">
                        <div>Date: ${day}</div>
                        <div class="text-red-300">❌ Absent</div>
                    </div>
                `;
            }
            
            tooltip.style.left = event.pageX + 'px';
            tooltip.style.top = (event.pageY - 60) + 'px';
            tooltip.classList.remove('opacity-0');
            tooltip.classList.add('opacity-100');
        }

        function hideTooltip() {
            const tooltip = document.getElementById('tooltip');
            tooltip.classList.remove('opacity-100');
            tooltip.classList.add('opacity-0');
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'973f57a0e1a4d9c7',t:'MTc1NjAwMTczMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>