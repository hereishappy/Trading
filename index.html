<!-- Index.html - Frontend for Shift Management Web App -->
<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>Shift Management Dashboard</title>
  <!-- Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f5f6fa; }
    .card { transition: box-shadow .2s; }
    .card:hover { box-shadow: 0 6px 20px rgba(0,0,0,0.13); }
    .form-floating > .form-control, .form-floating > .form-select { height: 54px; }
    @media (max-width: 575px) {
      .container, .container-fluid { padding-left: 6px; padding-right: 6px; }
      .card { margin-bottom: 1rem; }
    }
  </style>
</head>
<body>
<div class="container py-4">

  <!-- SUPERVISOR LOGIN CARD -->
  <div id="loginCard" class="row justify-content-center">
    <div class="col-md-6 col-sm-12">
      <div class="card shadow text-center">
        <div class="card-body">
          <h4 class="card-title pb-2">Supervisor Login</h4>
          <form id="loginForm">
            <div class="mb-3">
              <input class="form-control" required placeholder="Supervisor Name" id="loginName">
            </div>
            <div class="mb-3">
              <input type="password" class="form-control" required placeholder="Passcode" id="loginPass">
            </div>
            <button type="submit" class="btn btn-success w-50">Login</button>
          </form>
          <div id="loginError" class="text-danger mt-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN DASHBOARD CARDS -->
  <div id="dashboardCards" class="row d-none">
    <div class="col-md-6 col-sm-12 mb-3">
      <div class="card h-100 shadow text-center">
        <div class="card-body">
          <h5 class="card-title">Start Shift</h5>
          <p>Log workers starting a new shift.</p>
          <button class="btn btn-primary" id="startShiftBtn">Start Shift</button>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-sm-12 mb-3">
      <div class="card h-100 shadow text-center">
        <div class="card-body">
          <h5 class="card-title">End Shift</h5>
          <p>End shift, enter productivity and overtime.</p>
          <button class="btn btn-warning" id="endShiftBtn">End Shift</button>
        </div>
      </div>
    </div>
  </div>

  <!-- START SHIFT FORM -->
  <div id="startShiftForm" class="row d-none justify-content-center">
    <div class="col-md-8 col-sm-12">
      <div class="card shadow">
        <div class="card-body">
          <h5 class="mb-3">Start Shift</h5>
          <form id="startForm">
            <div class="mb-3">
              <label for="startWorkers" class="form-label">Select Workers</label>
              <select id="startWorkers" class="form-select" multiple required></select>
            </div>
            <div class="mb-3">
              <label for="startDetails" class="form-label">Additional Details</label>
              <textarea id="startDetails" class="form-control" rows="2"></textarea>
            </div>
            <button class="btn btn-success" type="submit">Submit Shift Start</button>
            <button class="btn btn-secondary ms-2" type="button" onclick="backToDashboard()">Cancel</button>
          </form>
          <div id="startError" class="text-danger mt-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- END SHIFT FORM -->
  <div id="endShiftForm" class="row d-none justify-content-center">
    <div class="col-md-8 col-sm-12">
      <div class="card shadow">
        <div class="card-body">
          <h5 class="mb-3">End Shift</h5>
          <form id="endForm">
            <div class="mb-3">
              <label for="endWorkers" class="form-label">Select Workers</label>
              <select id="endWorkers" class="form-select" multiple required></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Select Activity</label>
              <select class="form-select" id="endActivity" required>
                <option value="">Choose...</option>
                <option value="Erection">Erection</option>
                <option value="Dismantling">Dismantling</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Volume</label>
              <input type="number" step="0.01" min="0" id="endVolume" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Duration (hours)</label>
              <input type="number" min="0" step="0.01" id="endDuration" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Overtime (hours) [optional]</label>
              <input type="number" min="0" step="0.01" id="endOvertime" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">Remarks</label>
              <textarea id="endRemarks" class="form-control" rows="2"></textarea>
            </div>
            <button class="btn btn-warning" type="submit">End Shift</button>
            <button class="btn btn-secondary ms-2" type="button" onclick="backToDashboard()">Cancel</button>
          </form>
          <div id="endError" class="text-danger mt-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- REPORT RESULT CARD -->
  <div id="reportCard" class="row d-none justify-content-center">
    <div class="col-md-8 col-sm-12">
      <div class="card shadow">
        <div class="card-body text-center">
          <h5 class="mb-3" id="reportTitle">Report Generated</h5>
          <pre id="reportText" class="bg-light p-2 border rounded" style="font-size:1rem"></pre>
          <a class="btn btn-success my-2" id="whatsappShareBtn" href="#" target="_blank">Share via WhatsApp</a>
          <button class="btn btn-secondary" onclick="backToDashboard()">Back to Home</button>
        </div>
      </div>
    </div>
  </div>

</div>
<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let workerList = [];
let supervisor = null;

// Initial UI setup
document.addEventListener('DOMContentLoaded', function() {
  showCard('loginCard');
  
  // Login form
  document.getElementById('loginForm').onsubmit = function(e) {
    e.preventDefault();
    const name = document.getElementById('loginName').value.trim();
    const pass = document.getElementById('loginPass').value.trim();
    document.getElementById('loginError').textContent = '';
    
    google.script.run
      .withSuccessHandler(function(res){
        if (!res.success) {
          document.getElementById('loginError').textContent = res.message;
          return;
        }
        supervisor = res.supervisor;
        loadConfigAndShowDashboard();
      })
      .withFailureHandler(function(err){
        document.getElementById('loginError').textContent = err.message || "Login failed!";
      })
      .authenticateSupervisor({ name, passcode: pass });
  };

  document.getElementById('startShiftBtn').onclick = startShiftFlow;
  document.getElementById('endShiftBtn').onclick = endShiftFlow;

  document.getElementById('startForm').onsubmit = handleStartSubmit;
  document.getElementById('endForm').onsubmit = handleEndSubmit;
});

// UI helpers
function showCard(cardId) {
  for (let elemId of ['loginCard', 'dashboardCards', 'startShiftForm', 'endShiftForm', 'reportCard']) {
    document.getElementById(elemId).classList.add('d-none');
  }
  document.getElementById(cardId).classList.remove('d-none');
}
function backToDashboard() {
  showCard('dashboardCards');
}

// Supervisor logged in, load workers and show dashboard cards
function loadConfigAndShowDashboard() {
  google.script.run
    .withSuccessHandler(function(config){
      workerList = config.workers.map(w => w.name);
      // Populate worker selects
      populateWorkerSelect('startWorkers');
      populateWorkerSelect('endWorkers');
      showCard('dashboardCards');
    })
    .withFailureHandler(function(){
      alert("Failed to load worker list. Contact admin.");
    })
    .getConfigData();
}

// Populate multi-select worker menu
function populateWorkerSelect(selectId) {
  const sel = document.getElementById(selectId);
  sel.innerHTML = '';
  workerList.forEach(w => {
    const opt = document.createElement('option');
    opt.value = w;
    opt.textContent = w;
    sel.appendChild(opt);
  });
}

// Start Shift UI flow
function startShiftFlow() {
  document.getElementById('startForm').reset();
  document.getElementById('startError').textContent = '';
  showCard('startShiftForm');
}

// End Shift UI flow
function endShiftFlow() {
  document.getElementById('endForm').reset();
  document.getElementById('endError').textContent = '';
  showCard('endShiftForm');
}

// Start Shift Submission
function handleStartSubmit(e) {
  e.preventDefault();
  const workers = [...document.getElementById('startWorkers').selectedOptions].map(o=>o.value);
  const details = document.getElementById('startDetails').value;
  document.getElementById('startError').textContent = "";

  if (!workers.length) {
    document.getElementById('startError').textContent = "Select at least one worker.";
    return;
  }
  google.script.run
    .withSuccessHandler(function(res){
      if (res.success) {
        showReport("Shift Start Report", res.report);
      } else {
        document.getElementById('startError').textContent = res.message || "Submission failed.";
      }
    })
    .withFailureHandler(function(err){
      document.getElementById('startError').textContent = err.message || "Submission error.";
    })
    .submitStartShift({ workers, supervisor: supervisor.name, details });
}

// End Shift Submission
function handleEndSubmit(e) {
  e.preventDefault();
  const workers = [...document.getElementById('endWorkers').selectedOptions].map(o=>o.value);
  const activity = document.getElementById('endActivity').value;
  const volume = parseFloat(document.getElementById('endVolume').value);
  const duration = parseFloat(document.getElementById('endDuration').value);
  const overtime = document.getElementById('endOvertime').value;
  const remarks = document.getElementById('endRemarks').value;

  document.getElementById('endError').textContent = "";
  if (!activity) {
    document.getElementById('endError').textContent = "Select Activity.";
    return;
  }
  if (!volume || volume <= 0) {
    document.getElementById('endError').textContent = "Enter a valid volume.";
    return;
  }
  if (!duration || duration <= 0) {
    document.getElementById('endError').textContent = "Enter a valid duration.";
    return;
  }
  if (!workers.length) {
    document.getElementById('endError').textContent = "Select at least one worker.";
    return;
  }
  google.script.run
    .withSuccessHandler(function(res){
      if (res.success) {
        showReport("Shift End Report", res.report);
      } else {
        document.getElementById('endError').textContent = res.message || "Submission failed.";
      }
    })
    .withFailureHandler(function(err){
      document.getElementById('endError').textContent = err.message || "Submission error.";
    })
    .submitEndShift({
      supervisor: supervisor.name, 
      workers, activity, volume, duration,
      overtime: overtime ? parseFloat(overtime) : 0,
      remarks
    });
}

// Show report and WhatsApp share UI
function showReport(title, text) {
  document.getElementById('reportTitle').textContent = title;
  document.getElementById('reportText').textContent = text;
  // WhatsApp share URL (without phone number; add if desired)
  const waUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
  document.getElementById('whatsappShareBtn').href = waUrl;
  showCard('reportCard');
}

</script>
</body>
</html>
